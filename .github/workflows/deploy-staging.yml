name: ğŸš‚ Deploy to Railway Staging

on:
  push:
    branches: [ staging, main ]
  pull_request:
    branches: [ staging ]

jobs:
  deploy-staging:
    name: ğŸš€ Deploy to Railway
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“‹ Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, hash, json, mbstring, pcre, session, tokenizer, zip

    - name: ğŸ“¦ Install Dependencies
      run: |
        if [ -f "composer.json" ]; then
          composer install --no-dev --optimize-autoloader --no-interaction
        fi

    - name: ğŸ§ª Run Tests (Optional)
      run: |
        echo "â„¹ï¸ Running pre-deployment tests..."
        php -l index.php || echo "âš ï¸ No index.php found"
        echo "âœ… Basic syntax check completed"

    - name: ğŸš‚ Deploy to Railway
      if: github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main'
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        if [ -z "$RAILWAY_TOKEN" ]; then
          echo "ğŸ”„ Railway deployment skipped - no RAILWAY_TOKEN configured"
          echo ""
          echo "ğŸ“‹ To enable Railway deployment:"
          echo "1. Go to https://railway.app and create account"
          echo "2. Connect your GitHub repository"  
          echo "3. Get your Railway token from project settings"
          echo "4. Add RAILWAY_TOKEN secret in GitHub repository settings"
          echo ""
          echo "ğŸŒ Your staging site will be available at:"
          echo "   https://your-app-name.up.railway.app"
        else
          echo "ğŸš‚ Deploying to Railway..."
          # Install Railway CLI
          npm install -g @railway/cli
          
          # Deploy to Railway
          railway deploy --token $RAILWAY_TOKEN
          
          echo "âœ… Deployment to Railway completed!"
          echo "ğŸŒ Staging URL: Check Railway dashboard for deployment URL"
        fi

  notify-deployment:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: always()
    
    steps:
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ¯ CSIMS Staging Deployment Summary"
        echo "=================================="
        echo ""
        if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
          echo "âœ… Status: DEPLOYED SUCCESSFULLY"
          echo "ğŸš‚ Platform: Railway"
          echo "ğŸŒ Environment: Staging"
          echo "ğŸ“… Deployed: $(date)"
          echo ""
          echo "ğŸ”— Next Steps:"
          echo "1. Check your Railway dashboard for the live URL"
          echo "2. Test the staging environment"
          echo "3. If everything looks good, merge to main for production"
        else
          echo "âŒ Status: DEPLOYMENT FAILED"
          echo "ğŸ” Check the logs above for error details"
          echo "ğŸ’¡ Most common issues:"
          echo "   - Missing RAILWAY_TOKEN secret"
          echo "   - Railway project not configured"
          echo "   - Dependency installation failures"
        fi